name: Generate changelog file

on:
  workflow_run:
    workflows: ["Create release"]    # The exact name of your release workflow
    types:
      - completed

jobs:
  changelog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Generate release changelog
        id: changelog
        uses: janheinrichmerker/action-github-changelog-generator@v2.3
        with:
          token: ${{ secrets.PAT4PR }}
          verbose: true
      - name: Save changelog to file
        run: |
          printf 'Changelog file generated automatically. Do not edit.\n' > CHANGELOG.md
          printf 'Changelog generated at: %s\n' "$(date --iso-8601=seconds)" >> CHANGELOG.md
          printf '%s\n' "${{ steps.changelog.outputs.changelog }}" >> CHANGELOG.md
          chmod 644 CHANGELOG.md
      
      - name: Commit changelog
        uses: EndBug/add-and-commit@v7
        with:
          author_name: github-actions
          author_email: github-actions@github.com
          message: "robot: update CHANGELOG.md"
          add: 'CHANGELOG.md'
          push: true